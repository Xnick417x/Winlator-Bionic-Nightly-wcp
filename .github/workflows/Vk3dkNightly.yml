name: Build VKD3D-Proton (Force Hex Patch)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"

jobs:
  # ==================================================================
  # JOB 1: STANDARD BUILD (LOCKED)
  # ==================================================================
  build-standard:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git glslang-tools \
            build-essential python3 python3-pip pkg-config \
            meson ninja-build zstd

      - name: Setup Toolchain
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Checkout VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          fetch-depth: 0
          path: src

      - name: Generate Version Name
        run: |
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION_NAME=3.0b-${COMMIT_HASH}" >> $GITHUB_ENV

      - name: Build Standard
        run: |
          cat <<EOF > cross-x64.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'
          EOF

          cat <<EOF > cross-x86.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/i686-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          meson setup build-x64 --cross-file ../cross-x64.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x64
          meson setup build-x86 --cross-file ../cross-x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x86

      - name: Package Standard
        run: |
          rm -rf final_package
          mkdir -p final_package/system32
          mkdir -p final_package/syswow64
          
          find src/build-x64 -name "d3d12.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x64 -name "d3d12core.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x86 -name "d3d12.dll" -exec cp -L {} final_package/syswow64/ \;
          find src/build-x86 -name "d3d12core.dll" -exec cp -L {} final_package/syswow64/ \;
          
          cat <<EOF > final_package/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "vkd3d-proton Nightly",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF
          
          cd final_package
          tar -cJf ../VKD3D-Proton-${{ env.VERSION_NAME }}.wcp *

      - name: Upload Standard Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vkd3d-standard
          path: '*.wcp'


  # ==================================================================
  # JOB 2: ARM64EC BUILD (WITH NUCLEAR HEADER PATCH)
  # ==================================================================
  build-arm64ec:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          # Remove system meson to be safe
          sudo apt-get remove -y meson || true
          
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git glslang-tools \
            build-essential python3 python3-venv python3-pip \
            pkg-config cmake ninja-build zstd dos2unix perl tar unzip \
            llvm crossbuild-essential-arm64

      - name: Checkout VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          path: src

      - name: Setup Arihany Build Env
        run: |
          python3 -m venv .venv
          .venv/bin/python -m pip install "meson==1.2.3" "ninja==1.11.1"
          echo "$PWD/.venv/bin" >> $GITHUB_PATH
          
          LLVM_TAG="20251216"
          TOOLCHAIN="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_TAG/llvm-mingw-$LLVM_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN" && sudo mkdir -p "$TOOLCHAIN"
          sudo tar -C "$TOOLCHAIN" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN/bin" >> $GITHUB_PATH

      - name: Install SPIRV-Headers
        run: |
          SPV_TMP="$(mktemp -d)"
          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Headers.git "$SPV_TMP"
          for trip in x86_64-w64-mingw32 i686-w64-mingw32; do
            if [ -d "/opt/llvm-mingw/$trip/include" ]; then
              sudo mkdir -p "/opt/llvm-mingw/$trip/include/spirv"
              sudo cp -r "$SPV_TMP/include/spirv/"* "/opt/llvm-mingw/$trip/include/spirv/"
            fi
          done

      - name: Generate Version Name
        run: |
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION_NAME=3.0b-ARM64EC-${COMMIT_HASH}" >> $GITHUB_ENV

      - name: Build & Stage (Builds as ARM64EC)
        run: |
          MESON_BIN="$GITHUB_WORKSPACE/.venv/bin/meson"
          
          cat <<EOF > arm64ec.ini
          [binaries]
          c = 'arm64ec-w64-mingw32-gcc'
          cpp = 'arm64ec-w64-mingw32-g++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat <<EOF > x86.ini
          [binaries]
          c = 'i686-w64-mingw32-gcc'
          cpp = 'i686-w64-mingw32-g++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          $MESON_BIN setup build_ec --cross-file ../arm64ec.ini --buildtype release --prefix "$PWD/stage/ec" -Dstrip=false
          ninja -C build_ec install
          
          $MESON_BIN setup build_x86 --cross-file ../x86.ini --buildtype release --prefix "$PWD/stage/x86"
          ninja -C build_x86 install

      - name: NUCLEAR HEADER PATCH (FORCE OVERWRITE)
        run: |
          echo "==================================================="
          echo " SEARCHING FOR DLLs TO PATCH..."
          echo "==================================================="
          
          # Find all DLLs in the 'ec' stage directory
          find src/stage/ec -name "*.dll" > dll_list.txt
          cat dll_list.txt
          
          cat <<EOF > force_patch.py
          import sys
          import os
          
          print("--- STARTING PYTHON PATCHER ---")
          
          try:
              with open("dll_list.txt", "r") as f:
                  files = [line.strip() for line in f if line.strip()]
          except FileNotFoundError:
              print("ERROR: dll_list.txt not found!")
              sys.exit(1)
          
          if not files:
              print("ERROR: No DLLs found in list!")
              sys.exit(1)
          
          for file_path in files:
              print(f"Checking: {file_path}")
              try:
                  with open(file_path, "r+b") as f:
                      f.seek(0x3C)
                      pe_offset = int.from_bytes(f.read(4), 'little')
                      machine_offset = pe_offset + 4
                      
                      f.seek(machine_offset)
                      current = f.read(2)
                      print(f"  > Offset: {hex(machine_offset)} | Current Hex: {current.hex()}")
                      
                      if current == b'\x41\xa6':
                          print("  > DETECTED ARM64EC (0xA641). OVERWRITING...")
                          f.seek(machine_offset)
                          f.write(b'\x64\xaa')
                          print("  > SUCCESS: Wrote 0xAA64 (AARCH64)")
                      elif current == b'\x64\xaa':
                          print("  > SKIP: Already AARCH64")
                      else:
                          print(f"  > UNKNOWN TYPE: {current.hex()}")
                          
              except Exception as e:
                  print(f"  > ERROR: {e}")
                  sys.exit(1)
          print("--- PATCHING COMPLETE ---")
          EOF
          
          python3 force_patch.py

      - name: VERIFY ARCHITECTURE (Final Check)
        run: |
          echo "=========================================="
          echo "VERIFYING DLL ARCHITECTURE AFTER PATCH..."
          
          # Check the Header
          MACHINE_TYPE=$(/opt/llvm-mingw/bin/llvm-readobj -h src/stage/ec/bin/d3d12.dll | grep "Machine:")
          echo "FOUND: $MACHINE_TYPE"
          
          if echo "$MACHINE_TYPE" | grep -q "AARCH64"; then
             echo "SUCCESS: Binary matches AARCH64."
          else
             # If this fails now, it means the disk write failed, which is impossible in CI.
             echo "::error::FAILURE: Patch failed! Still shows: $MACHINE_TYPE"
             exit 1
          fi
          echo "=========================================="

      - name: Package ARM64EC
        run: |
          rm -rf final_package
          mkdir -p final_package/system32 final_package/syswow64
          
          cp -L src/stage/ec/bin/*.dll final_package/system32/
          cp -L src/stage/x86/bin/*.dll final_package/syswow64/

          # Manual Strip
          /opt/llvm-mingw/bin/llvm-strip --strip-all final_package/system32/*.dll
          /opt/llvm-mingw/bin/llvm-strip --strip-all final_package/syswow64/*.dll

          echo "{}" > final_package/profile.json
          jq -n \
            --arg vn "${{ env.VERSION_NAME }}" \
            '{
              type: "VKD3D",
              versionName: $vn,
              versionCode: 0,
              description: ("vkd3d-proton Nightly " + $vn),
              files: []
            }' > final_package/profile.json

          for f in final_package/system32/*.dll final_package/syswow64/*.dll; do
              [ -e "$f" ] || continue
              REL_PATH=${f#final_package/}
              FOLDER=$(dirname "$REL_PATH")
              if [[ "$FOLDER" == "system32" ]]; then TARGET="\${system32}"; else TARGET="\${syswow64}"; fi
              jq --arg src "$REL_PATH" --arg tgt "$TARGET/$(basename "$f")" \
                 '.files += [{"source": $src, "target": $tgt}]' \
                 final_package/profile.json > final_package/tmp.json && mv final_package/tmp.json final_package/profile.json
          done

          chmod -R 777 final_package
          cd final_package
          tar --zstd --format=gnu --owner=0 --group=0 --numeric-owner -cf ../VKD3D-Proton-${{ env.VERSION_NAME }}.wcp *

      - name: Upload ARM64EC Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vkd3d-arm64ec
          path: '*.wcp'
