name: Build VKD3D-Proton (Arihany Static Fix)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install Dependencies
        run: |
          pacman -Sy --noconfirm git base-devel glslang python python-pip cmake ninja jq wget tar zstd

      - name: Checkout VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          path: src

      - name: Setup Toolchain (Arihany's Version)
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install "meson==1.2.3" "ninja==1.11.1"
          
          # We use the 20251104 toolchain which is known stable for EC
          LLVM_TAG="20251104"
          TOOLCHAIN="/opt/llvm-mingw"
          mkdir -p "$TOOLCHAIN"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_TAG/llvm-mingw-$LLVM_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          tar -C "$TOOLCHAIN" --strip-components=1 -xJf llvm.tar.xz
          
          echo "$TOOLCHAIN/bin" >> $GITHUB_PATH
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Install SPIRV-Headers
        run: |
          SPV_TMP="$(mktemp -d)"
          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Headers.git "$SPV_TMP"
          
          # Install to ALL paths to be safe
          for trip in x86_64-w64-mingw32 i686-w64-mingw32 arm64ec-w64-mingw32; do
            if [ -d "/opt/llvm-mingw/$trip/include" ]; then
              mkdir -p "/opt/llvm-mingw/$trip/include/spirv"
              cp -r "$SPV_TMP/include/spirv/"* "/opt/llvm-mingw/$trip/include/spirv/"
            fi
          done

      - name: Generate Version Name
        run: |
          cd src
          git config --global --add safe.directory '*'
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION_NAME=3.0b-ARM64EC-${COMMIT_HASH}" >> $GITHUB_ENV

      - name: Build & Stage (The Static Fix)
        run: |
          # 1. ARM64EC CONFIG
          cat <<EOF > arm64ec.ini
          [binaries]
          c = 'arm64ec-w64-mingw32-gcc'
          cpp = 'arm64ec-w64-mingw32-g++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          
          [built-in options]
          # THE FIX: Force static linking of standard libraries
          c_link_args = ['-static', '-static-libgcc', '-static-libstdc++']
          cpp_link_args = ['-static', '-static-libgcc', '-static-libstdc++']
          
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          # 2. X86 CONFIG
          cat <<EOF > x86.ini
          [binaries]
          c = 'i686-w64-mingw32-gcc'
          cpp = 'i686-w64-mingw32-g++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          
          [built-in options]
          # Static here too, just in case
          c_link_args = ['-static', '-static-libgcc', '-static-libstdc++']
          cpp_link_args = ['-static', '-static-libgcc', '-static-libstdc++']

          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          # Enable strip=true (Standard Arihany behavior)
          meson setup build_ec --cross-file ../arm64ec.ini --buildtype release --prefix "$PWD/stage/ec" -Dstrip=true
          ninja -C build_ec install
          
          meson setup build_x86 --cross-file ../x86.ini --buildtype release --prefix "$PWD/stage/x86" -Dstrip=true
          ninja -C build_x86 install

      - name: Package Final
        run: |
          rm -rf final_package
          mkdir -p final_package/system32 final_package/syswow64
          
          cp -L src/stage/ec/bin/*.dll final_package/system32/
          cp -L src/stage/x86/bin/*.dll final_package/syswow64/

          # Create JSON for Winlator
          echo "{}" > final_package/profile.json
          jq -n \
            --arg vn "${{ env.VERSION_NAME }}" \
            '{
              type: "VKD3D",
              versionName: $vn,
              versionCode: 0,
              description: ("vkd3d-proton Nightly " + $vn + " (Static)"),
              files: []
            }' > final_package/profile.json

          for f in final_package/system32/*.dll final_package/syswow64/*.dll; do
              [ -e "$f" ] || continue
              REL_PATH=${f#final_package/}
              FOLDER=$(dirname "$REL_PATH")
              if [[ "$FOLDER" == "system32" ]]; then TARGET="\${system32}"; else TARGET="\${syswow64}"; fi
              jq --arg src "$REL_PATH" --arg tgt "$TARGET/$(basename "$f")" \
                 '.files += [{"source": $src, "target": $tgt}]' \
                 final_package/profile.json > final_package/tmp.json && mv final_package/tmp.json final_package/profile.json
          done

          chmod -R 777 final_package
          cd final_package
          tar --zstd --format=gnu --owner=0 --group=0 --numeric-owner -cf ../VKD3D-Proton-${{ env.VERSION_NAME }}.wcp *

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vkd3d-arihany-static
          path: '*.wcp'
