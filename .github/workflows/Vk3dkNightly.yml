name: Build VKD3D-Proton (Arihany Blueprint Reproduction)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"

jobs:
  # ==================================================================
  # JOB 1: STANDARD BUILD (Untouched - Your Working Version)
  # ==================================================================
  build-standard:
    runs-on: ubuntu-latest
    steps:
    - name: Install Dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          ca-certificates curl xz-utils jq git glslang-tools \
          build-essential python3 python3-pip pkg-config \
          meson ninja-build zstd

    - name: Setup Toolchain
      run: |
        LLVM_MINGW_TAG="20251104"
        TOOLCHAIN_DIR="/opt/llvm-mingw"
        wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
        sudo rm -rf "$TOOLCHAIN_DIR" && sudo mkdir -p "$TOOLCHAIN_DIR"
        sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
        echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

    - name: Checkout VKD3D
      uses: actions/checkout@v4
      with:
        repository: HansKristian-Work/vkd3d-proton
        submodules: recursive
        path: src

    - name: Generate Version Name
      run: |
        cd src
        echo "VERSION_NAME=3.0b-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - name: Build & Package Standard
      run: |
        cat <<EOF > cross-x64.txt
        [binaries]
        c = 'x86_64-w64-mingw32-clang'
        cpp = 'x86_64-w64-mingw32-clang++'
        ar = 'llvm-ar'
        strip = 'llvm-strip'
        [host_machine]
        system = 'windows'
        cpu_family = 'x86_64'
        cpu = 'x86_64'
        endian = 'little'
        EOF

        cat <<EOF > cross-x86.txt
        [binaries]
        c = 'i686-w64-mingw32-clang'
        cpp = 'i686-w64-mingw32-clang++'
        ar = 'llvm-ar'
        strip = 'llvm-strip'
        [host_machine]
        system = 'windows'
        cpu_family = 'x86'
        cpu = 'i686'
        endian = 'little'
        EOF

        cd src
        meson setup build-x64 --cross-file ../cross-x64.txt -Dbuildtype=release
        ninja -C build-x64
        meson setup build-x86 --cross-file ../cross-x86.txt -Dbuildtype=release
        ninja -C build-x86

        mkdir -p ../final_package/system32 ../final_package/syswow64
        find build-x64 -name "d3d12*.dll" -exec cp -L {} ../final_package/system32/ \;
        find build-x86 -name "d3d12*.dll" -exec cp -L {} ../final_package/syswow64/ \;
        
        echo '{"type": "VKD3D","versionName": "${{ env.VERSION_NAME }}","versionCode": 0,"description": "vkd3d-proton Nightly","files": [{"source": "system32/d3d12.dll", "target": "${system32}/d3d12.dll"},{"source": "system32/d3d12core.dll", "target": "${system32}/d3d12core.dll"},{"source": "syswow64/d3d12.dll", "target": "${syswow64}/d3d12.dll"},{"source": "syswow64/d3d12core.dll", "target": "${syswow64}/d3d12core.dll"}]}' > ../final_package/profile.json
        cd ../final_package && tar -cJf ../vkd3d-standard.wcp *

    - name: Upload Standard
      uses: actions/upload-artifact@v4
      with:
        name: vkd3d-standard
        path: vkd3d-standard.wcp

  # ==================================================================
  # JOB 2: ARM64EC BUILD (REPRODUCING ARIHANY'S EXACT ENVIRONMENT)
  # ==================================================================
  build-arm64ec:
    runs-on: ubuntu-latest
    steps:
    - name: Install Dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          ca-certificates curl xz-utils jq git glslang-tools \
          build-essential python3 python3-venv python3-pip pkg-config \
          ninja-build zstd tar unzip llvm

    - name: Setup Arihany Environment (Meson 1.2.3 + LLVM 20251216)
      run: |
        python3 -m venv .venv
        .venv/bin/python -m pip install "meson==1.2.3" "ninja==1.11.1"
        echo "$PWD/.venv/bin" >> $GITHUB_PATH

        LLVM_TAG="20251216"
        TOOLCHAIN="/opt/llvm-mingw"
        wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_TAG/llvm-mingw-$LLVM_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
        sudo rm -rf "$TOOLCHAIN" && sudo mkdir -p "$TOOLCHAIN"
        sudo tar -C "$TOOLCHAIN" --strip-components=1 -xJf llvm.tar.xz
        echo "$TOOLCHAIN/bin" >> $GITHUB_PATH

    - name: Install SPIRV-Headers (Arihany Secret Fix)
      run: |
        SPV_TMP="$(mktemp -d)"
        git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Headers.git "$SPV_TMP"
        for trip in x86_64-w64-mingw32 i686-w64-mingw32 arm64ec-w64-mingw32; do
          if [ -d "/opt/llvm-mingw/$trip/include" ]; then
            sudo mkdir -p "/opt/llvm-mingw/$trip/include/spirv"
            sudo cp -r "$SPV_TMP/include/spirv/"* "/opt/llvm-mingw/$trip/include/spirv/"
          fi
        done

    - name: Checkout VKD3D
      uses: actions/checkout@v4
      with:
        repository: HansKristian-Work/vkd3d-proton
        submodules: recursive
        path: src

    - name: Build (Arihany Cross-Config)
      run: |
        # ARM64EC ini: cpu_family = aarch64 is key for Winlator detection
        cat <<EOF > arm64ec.ini
        [binaries]
        c = 'arm64ec-w64-mingw32-clang'
        cpp = 'arm64ec-w64-mingw32-clang++'
        ar = 'llvm-ar'
        strip = 'llvm-strip'
        windres = 'arm64ec-w64-mingw32-windres'
        [host_machine]
        system = 'windows'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF

        cat <<EOF > x86.ini
        [binaries]
        c = 'i686-w64-mingw32-clang'
        cpp = 'i686-w64-mingw32-clang++'
        ar = 'llvm-ar'
        strip = 'llvm-strip'
        [host_machine]
        system = 'windows'
        cpu_family = 'x86'
        cpu = 'i686'
        endian = 'little'
        EOF

        cd src
        # Disable LTO and use Arihany's prefix-install logic
        meson setup build_ec --cross-file ../arm64ec.ini --buildtype release --prefix "$PWD/pkg/arm64ec" -Db_lto=false -Dstrip=false
        ninja -C build_ec install
        
        meson setup build_x32 --cross-file ../x86.ini --buildtype release --prefix "$PWD/pkg/x32"
        ninja -C build_x32 install

    - name: Package (Arihany Packaging Logic)
      run: |
        mkdir -p final/system32 final/syswow64
        cp -L src/pkg/arm64ec/bin/*.dll final/system32/
        cp -L src/pkg/x32/bin/*.dll final/syswow64/
        
        # Manual safe strip
        llvm-strip --strip-all final/system32/*.dll
        
        # Dynamic JSON Generation
        echo '{"type": "VKD3D","versionName": "3.0b-ARM64EC","versionCode": 0,"description": "Arihany Logic Build","files": []}' > final/profile.json
        for f in final/system32/*.dll final/syswow64/*.dll; do
            REL=${f#final/}
            DIR=$(dirname "$REL")
            jq --arg s "$REL" --arg t "\${$DIR}/$(basename "$f")" '.files += [{"source": $s, "target": $t}]' final/profile.json > tmp.json && mv tmp.json final/profile.json
        done

        # Pack with GNU format and owner reset to avoid permission issues
        cd final
        tar --format=gnu --owner=0 --group=0 -cJf ../vkd3d-arm64ec.wcp *

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: vkd3d-arm64ec
        path: vkd3d-arm64ec.wcp
