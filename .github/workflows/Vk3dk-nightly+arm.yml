name: Build Vk3dk Combined

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-standard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          fetch-depth: 0
          path: src

      - name: Check for Updates
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          else
            cd src
            if [ -z "$(git log --since='26 hours ago' --pretty=format:'%H')" ]; then
              echo "SHOULD_BUILD=false" >> $GITHUB_ENV
            else
              echo "SHOULD_BUILD=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Dependencies
        if: env.SHOULD_BUILD == 'true'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git glslang-tools \
            build-essential python3 python3-pip pkg-config \
            meson ninja-build zstd

      - name: Setup Toolchain (llvm-mingw)
        if: env.SHOULD_BUILD == 'true'
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Generate Version Info
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="3.0b-${COMMIT_HASH}"
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV

      - name: Build Standard
        if: env.SHOULD_BUILD == 'true'
        run: |
          cat <<EOF > cross-x64.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'
          EOF
          cat <<EOF > cross-x86.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/i686-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF
          cd src
          meson setup build-x64 --cross-file ../cross-x64.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x64
          meson setup build-x86 --cross-file ../cross-x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x86

      - name: Package Standard
        if: env.SHOULD_BUILD == 'true'
        run: |
          rm -rf final_package
          mkdir -p final_package/system32 final_package/syswow64
          find src/build-x64 -name "d3d12.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x64 -name "d3d12core.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x86 -name "d3d12.dll" -exec cp -L {} final_package/syswow64/ \;
          find src/build-x86 -name "d3d12core.dll" -exec cp -L {} final_package/syswow64/ \;
          cat <<EOF > final_package/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "Vk3dk Standard Nightly ${{ env.COMMIT_HASH }}",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF
          cd final_package
          tar -cJf ../Vk3dk-Standard-${{ env.VERSION_NAME }}.wcp *

      - name: Create Release (Standard)
        if: env.SHOULD_BUILD == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: vk3dk-nightly-${{ env.COMMIT_HASH }}
          files: '*.wcp'
          name: "Vk3dk Standard Nightly ${{ env.COMMIT_HASH }}"
          body: |
            Automated nightly build of Vk3dk (Standard).
            Commit: https://github.com/HansKristian-Work/vkd3d-proton/commit/${{ env.COMMIT_HASH }}

      - name: Cleanup Old Releases (Standard)
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName | select(startswith("vk3dk-nightly-"))' | tail -n +9 | xargs -I {} sh -c 'gh release delete "{}" --cleanup-tag -y'

      - name: Update Dashboard (Standard)
        if: env.SHOULD_BUILD == 'true'
        uses: actions/checkout@v4
        with:
          path: dashboard

      - name: Push README Updates (Standard)
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dashboard
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/vk3dk-nightly-${{ env.COMMIT_HASH }}/Vk3dk-Standard-${{ env.VERSION_NAME }}.wcp"
          sed -i "/\*\*VKD3D-Proton\*\* (Standard)/ s|\[\*\*Download Latest\*\*\]([^)]*)|[**Download Latest**]($DOWNLOAD_URL)|" README.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update dashboard for Vk3dk Standard ${{ env.COMMIT_HASH }}"
          git push

  build-arm64ec:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          fetch-depth: 0
          path: src

      - name: Check for Updates
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          else
            cd src
            if [ -z "$(git log --since='26 hours ago' --pretty=format:'%H')" ]; then
              echo "SHOULD_BUILD=false" >> $GITHUB_ENV
            else
              echo "SHOULD_BUILD=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Dependencies
        if: env.SHOULD_BUILD == 'true'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git python3 pkg-config \
            zstd meson ninja-build wget unzip build-essential

      - name: Setup GLSLang
        if: env.SHOULD_BUILD == 'true'
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup Toolchain (llvm-mingw)
        if: env.SHOULD_BUILD == 'true'
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Generate Version Info
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="3.0b-arm64ec-${COMMIT_HASH}"
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV

      - name: Build ARM64EC
        if: env.SHOULD_BUILD == 'true'
        run: |
          cat <<EOF > arm64ec.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
          cat <<EOF > x86.txt
          [binaries]
          c = 'i686-w64-mingw32-clang'
          cpp = 'i686-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-windres'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF
          cd src
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-ec -j 2
          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x86 -j 2

      - name: Package ARM64EC
        if: env.SHOULD_BUILD == 'true'
        run: |
          rm -rf final_package
          mkdir -p final_package/system32 final_package/syswow64
          find src/build-ec -name "d3d12.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-ec -name "d3d12core.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x86 -name "d3d12.dll" -exec cp -L {} final_package/syswow64/ \;
          find src/build-x86 -name "d3d12core.dll" -exec cp -L {} final_package/syswow64/ \;
          llvm-strip --strip-all final_package/system32/*.dll
          llvm-strip --strip-all final_package/syswow64/*.dll
          cat <<EOF > final_package/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 1,
            "description": "Vk3dk Arm64ec Nightly ${{ env.COMMIT_HASH }}",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF
          cd final_package
          tar -cf ../archive.tar .
          cd ..
          xz -9 archive.tar
          mv archive.tar.xz Vk3dk-Arm64ec-${{ env.VERSION_NAME }}.wcp

      - name: Create Release (ARM64EC)
        if: env.SHOULD_BUILD == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: vk3dk-arm64ec-nightly-${{ env.COMMIT_HASH }}
          files: '*.wcp'
          name: "Vk3dk Arm64ec Nightly ${{ env.COMMIT_HASH }}"
          body: |
            Automated nightly build of Vk3dk (Arm64ec).
            Commit: https://github.com/HansKristian-Work/vkd3d-proton/commit/${{ env.COMMIT_HASH }}

      - name: Cleanup Old Releases (ARM64EC)
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName | select(startswith("vk3dk-arm64ec-nightly-"))' | tail -n +9 | xargs -I {} sh -c 'gh release delete "{}" --cleanup-tag -y'

      - name: Update Dashboard (ARM64EC)
        if: env.SHOULD_BUILD == 'true'
        uses: actions/checkout@v4
        with:
          path: dashboard

      - name: Push README Updates (ARM64EC)
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dashboard
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/vk3dk-arm64ec-nightly-${{ env.COMMIT_HASH }}/Vk3dk-Arm64ec-${{ env.VERSION_NAME }}.wcp"
          sed -i "/\*\*VKD3D-Proton\*\* (ARM64EC)/ s|\[\*\*Download Latest\*\*\]([^)]*)|[**Download Latest**]($DOWNLOAD_URL)|" README.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update dashboard for Vk3dk ARM64EC ${{ env.COMMIT_HASH }}"
          git push
