name: Build Wine 11.0 v57 (Staging + Android + SDL2)
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Cleanup
        run: sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git wget tar xz-utils flex bison pkg-config \
          gcc-multilib g++-multilib libx11-dev libpulse-dev libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev libsdl2-dev patch python3 autoconf

      - name: Setup Toolchains
        run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz
          tar -xf llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz
          echo "$(pwd)/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH
          echo "NDK_BIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV
          echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Clone Sources
        run: |
          # 1. Main Wine Source
          git clone --depth 1 --branch wine-11.0 https://gitlab.winehq.org/wine/wine.git source
          # 2. Staging Patches (The Game Fixes)
          git clone --depth 1 --branch wine-11.0 https://github.com/wine-staging/wine-staging.git staging_source

      - name: Apply Staging (Game Fixes)
        run: |
          cd staging_source
          ./patches/patchinstall.sh DESTDIR=../source --all --backend=patch

      - name: Apply Android Patches (Boot Fixes)
        run: |
          cd source
          # Pipetto (Boot)
          for p in c9ee4e003238c9461461156f986d91349de27fea 441c0fe673de0a640e176110d9442e8e41250fd7 6e7166c71de8c09a1c91fb96228920e7085e2366; do
            wget https://github.com/Pipetto-crypto/wine/commit/$p.patch -O p.patch && patch -p1 < p.patch || true
          done
          # Bruno (Desktop/Black Screen Fix)
          wget https://github.com/brunodev85/wine-9.2-custom/commit/a4ef2bf8963fe4bfab390eebf73336364ce209bc.patch -O bruno_desktop.patch && patch -p1 < bruno_desktop.patch || true
          wget https://github.com/brunodev85/wine-9.2-custom/commit/73336364ce209bc.patch -O bruno_shell.patch && patch -p1 < bruno_shell.patch || true
          # Airidosas (Performance)
          wget https://raw.githubusercontent.com/airidosas252/Wine-Builds/master/address-space-proot.patch && patch -p1 < address-space-proot.patch || true
          wget https://raw.githubusercontent.com/airidosas252/Wine-Builds/master/esync.patch && patch -p1 < esync.patch || true
          
          # Preloader Manual Fixes
          sed -i 's/base = (char \*)0x10000;/base = NULL;/g' dlls/ntdll/unix/virtual.c
          sed -i 's/size = 0x110000;/size = 0;/g' dlls/ntdll/unix/virtual.c
          sed -i 's/0x00010000/0x00000000/g' loader/preloader.c || true
          
          # Regenerate Config
          autoreconf -f

      - name: Build Native Tools
        run: |
          mkdir -p source/build_native
          cd source/build_native
          ../configure --enable-win64 --without-x --without-freetype
          make -j$(nproc) __wine_tools_install_lib__

      - name: Build Android Target
        run: |
          mkdir -p source/build_android
          cd source/build_android
          TARGET="x86_64-linux-android28"
          export CC="$NDK_BIN/${TARGET}-clang"
          export CXX="$NDK_BIN/${TARGET}-clang++"
          export LD="$NDK_BIN/ld"
          export CROSS_COMPILE="llvm-"
          export CFLAGS="-O2 -g0"
          export CXXFLAGS="-O2 -g0"
          TOOLS_PATH="$(pwd)/../build_native"
          
          ../configure \
            --host=$TARGET \
            --with-wine-tools=$TOOLS_PATH \
            --enable-archs=i386,x86_64 \
            --prefix=/usr \
            --with-mingw=clang \
            --with-sdl \
            --enable-win64 \
            --enable-nls \
            --with-pulse \
            --with-x \
            --disable-win16 \
            --disable-opencl \
            --disable-tests \
            --without-wayland \
            --without-capi \
            --without-coreaudio \
            --without-cups \
            --without-dbus \
            --without-gphoto \
            --without-gssapi \
            --without-krb5 \
            --without-netapi \
            --without-oss \
            --without-pcap \
            --without-pcsclite \
            --without-sane \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-xinerama \
            --without-xxf86vm \
            --without-osmesa \
            --enable-wineandroid_drv=no

          make -j$(nproc)
          make install DESTDIR=$(pwd)/stage

      - name: Package Prefix
        run: |
          mkdir -p prefix_root/.wine/drive_c/windows/system32
          mkdir -p prefix_root/.wine/drive_c/windows/syswow64
          mkdir -p prefix_root/.wine/drive_c/users/xuser
          
          cp -r source/build_android/stage/usr/lib/wine/x86_64-windows/* prefix_root/.wine/drive_c/windows/system32/
          cp -r source/build_android/stage/usr/lib/wine/i386-windows/* prefix_root/.wine/drive_c/windows/syswow64/
          
          printf "WINE REGISTRY Version 2\n\n[System\\\\CurrentControlSet\\\\Control\\\\Video\\\\{00000000-0000-0000-0000-000000000000}\\\\0000]\n\"Renderer\"=\"vulkan\"\n" > prefix_root/.wine/system.reg
          echo "WINE REGISTRY Version 2" > prefix_root/.wine/user.reg
          echo "WINE REGISTRY Version 2" > prefix_root/.wine/userdef.reg
          
          cd prefix_root
          tar -cJf ../prefixPack.txz .wine

      - name: Assemble
        run: |
          mkdir staging
          mkdir -p staging/bin staging/lib staging/share
          cp -r source/build_android/stage/usr/bin/* staging/bin/
          cp -r source/build_android/stage/usr/lib/* staging/lib/
          cp -r source/build_android/stage/usr/share/* staging/share/
          mv prefixPack.txz staging/
          
          cat <<EOF > staging/profile.json
          {
            "type": "Wine",
            "versionName": "Wine 11.0 v57",
            "versionCode": 57,
            "description": "v57 Staging (Game Ready)",
            "files": [],
            "wine": {
              "binPath": "bin",
              "libPath": "lib",
              "prefixPack": "prefixPack.txz"
            }
          }
          EOF
          
          cd staging && tar -cJf ../Wine-11.0-v57.wcp *

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Wine-11.0-v57
          path: Wine-11.0-v57.wcp
