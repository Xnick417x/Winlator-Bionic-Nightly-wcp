name: Build DXVK+NVAPI Combined

on:
  push:
    branches:
      - Na
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-standard:
    name: Build DXVK+NVAPI (Standard)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout DXVK
        uses: actions/checkout@v4
        with:
          repository: doitsujin/dxvk
          path: dxvk
          submodules: recursive
          fetch-depth: 0

      - name: Check for Updates
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.event_name }}" == "push" ]]; then
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          else
            cd dxvk
            if [ -z "$(git log --since='26 hours ago' --pretty=format:'%H')" ]; then
              echo "SHOULD_BUILD=false" >> $GITHUB_ENV
            else
              echo "SHOULD_BUILD=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Dependencies
        if: env.SHOULD_BUILD == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build mingw-w64 glslang-tools wine pkg-config

      - name: Download DXVK-NVAPI
        if: env.SHOULD_BUILD == 'true'
        run: |
          git clone --recursive https://github.com/jp7677/dxvk-nvapi.git dxvk-nvapi
          cd dxvk-nvapi
          NVAPI_HASH=$(git rev-parse --short HEAD)
          echo "NVAPI_HASH=${NVAPI_HASH}" >> $GITHUB_ENV

      - name: Download and Apply DXVK Patch
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk
          wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
          git apply dxvk-gplasync-master.patch

      - name: Build DXVK
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk
          ./package-release.sh master ../dxvk-built --no-package

      - name: Build DXVK-NVAPI
        if: env.SHOULD_BUILD == 'true'
        run: |
          cat <<EOF > cross-x64.txt
          [binaries]
          c = 'x86_64-w64-mingw32-gcc'
          cpp = 'x86_64-w64-mingw32-g++'
          ar = 'x86_64-w64-mingw32-ar'
          strip = 'x86_64-w64-mingw32-strip'
          windres = 'x86_64-w64-mingw32-windres'
          widl = 'x86_64-w64-mingw32-widl'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'
          EOF

          cat <<EOF > cross-x86.txt
          [binaries]
          c = 'i686-w64-mingw32-gcc'
          cpp = 'i686-w64-mingw32-g++'
          ar = 'i686-w64-mingw32-ar'
          strip = 'i686-w64-mingw32-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd dxvk-nvapi
          meson setup build-x64 --cross-file ../cross-x64.txt -Dbuildtype=release -Dstrip=true
          meson setup build-x86 --cross-file ../cross-x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x64 -j 2
          ninja -C build-x86 -j 2

      - name: Prepare Package
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk
          COMMIT_HASH=$(git rev-parse --short HEAD)
          cd ..

          mkdir -p packaging/system32 packaging/syswow64
          cp dxvk-built/dxvk-master/x64/*.dll packaging/system32/
          cp dxvk-built/dxvk-master/x32/*.dll packaging/syswow64/
          
          find dxvk-nvapi/build-x64 -name "nvapi64.dll" -exec cp -L {} packaging/system32/ \;
          find dxvk-nvapi/build-x86 -name "nvapi.dll" -exec cp -L {} packaging/syswow64/ \;

          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK-NVAPI",
            "versionName": "2.7.1-nvapi-${COMMIT_HASH}",
            "versionCode": 0,
            "description": "DXVK 2.7.1 GPLAsync + NVAPI",
            "files": [
              {
                "source": "system32/d3d9.dll",
                "target": "\${system32}/d3d9.dll"
              },
              {
                "source": "system32/d3d10core.dll",
                "target": "\${system32}/d3d10core.dll"
              },
              {
                "source": "system32/d3d11.dll",
                "target": "\${system32}/d3d11.dll"
              },
              {
                "source": "system32/dxgi.dll",
                "target": "\${system32}/dxgi.dll"
              },
              {
                "source": "system32/nvapi64.dll",
                "target": "\${system32}/nvapi64.dll"
              },
              {
                "source": "syswow64/d3d9.dll",
                "target": "\${syswow64}/d3d9.dll"
              },
              {
                "source": "syswow64/d3d10core.dll",
                "target": "\${syswow64}/d3d10core.dll"
              },
              {
                "source": "syswow64/d3d11.dll",
                "target": "\${syswow64}/d3d11.dll"
              },
              {
                "source": "syswow64/dxgi.dll",
                "target": "\${syswow64}/dxgi.dll"
              },
              {
                "source": "syswow64/nvapi.dll",
                "target": "\${syswow64}/nvapi.dll"
              }
            ]
          }
          EOF

      - name: Create WCP Package
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
          cd ../packaging
          tar -cJf ../dxvk-nvapi-gplasync-${COMMIT_HASH}.wcp *

      - name: Create Release
        if: env.SHOULD_BUILD == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dxvk-nvapi-nightly-${{ env.COMMIT_HASH }}
          files: '*.wcp'
          name: "DXVK+NVAPI Nightly ${{ env.COMMIT_HASH }}"
          body: |
            Automated nightly build of DXVK (GPLAsync) bundled with DXVK-NVAPI.
            
            DXVK Commit: https://github.com/doitsujin/dxvk/commit/${{ env.COMMIT_HASH }}
            DXVK-NVAPI Commit: https://github.com/jp7677/dxvk-nvapi/commit/${{ env.NVAPI_HASH }}

      - name: Cleanup Old Releases
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName | select(startswith("dxvk-nvapi-nightly-"))' \
          | tail -n +9 \
          | xargs -I {} sh -c 'gh release delete "{}" --cleanup-tag -y'

      - name: Checkout Dashboard
        if: env.SHOULD_BUILD == 'true'
        uses: actions/checkout@v4
        with:
          path: dashboard
          fetch-depth: 0

      - name: Update Dashboard (Standard)
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dashboard
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/dxvk-nvapi-nightly-${{ env.COMMIT_HASH }}/dxvk-nvapi-gplasync-${{ env.COMMIT_HASH }}.wcp"
          BRANCH_NAME="${{ github.ref_name }}"
          
          git checkout $BRANCH_NAME 2>/dev/null || git checkout -b $BRANCH_NAME
          
          n=0
          until [ "$n" -ge 5 ]
          do
             git pull origin $BRANCH_NAME --rebase
             sed -i "/\*\*DXVK-NVAPI\*\* (GPLAsync)/ s|\[\*\*Download Latest\*\*\]([^)]*)|[**Download Latest**]($DOWNLOAD_URL)|" README.md
             git add README.md
             git commit -m "Update dashboard for DXVK+NVAPI Standard ${{ env.COMMIT_HASH }}" || echo "Nothing to commit"
             if git push origin $BRANCH_NAME; then exit 0; fi
             n=$((n+1))
             sleep 15
          done
          exit 1

  build-arm64ec:
    name: Build DXVK+NVAPI (ARM64EC)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout DXVK
        uses: actions/checkout@v4
        with:
          repository: doitsujin/dxvk
          path: dxvk
          submodules: recursive
          fetch-depth: 0

      - name: Check for Updates
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.event_name }}" == "push" ]]; then
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          else
            cd dxvk
            if [ -z "$(git log --since='26 hours ago' --pretty=format:'%H')" ]; then
              echo "SHOULD_BUILD=false" >> $GITHUB_ENV
            else
              echo "SHOULD_BUILD=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Dependencies
        if: env.SHOULD_BUILD == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates curl xz-utils jq git build-essential \
            python3 pkg-config zstd meson ninja-build wget unzip

      - name: Setup Glslang
        if: env.SHOULD_BUILD == 'true'
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup LLVM-MinGW
        if: env.SHOULD_BUILD == 'true'
        run: |
          LLVM_MINGW_TAG="20251104"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          tar -xf llvm.tar.xz
          echo "$PWD/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

      - name: Download DXVK-NVAPI
        if: env.SHOULD_BUILD == 'true'
        run: |
          git clone --recursive https://github.com/jp7677/dxvk-nvapi.git dxvk-nvapi
          cd dxvk-nvapi
          NVAPI_HASH=$(git rev-parse --short HEAD)
          echo "NVAPI_HASH=${NVAPI_HASH}" >> $GITHUB_ENV

      - name: Patch DXVK
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk
          wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
          git apply dxvk-gplasync-master.patch

      - name: Generate Version Info
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
          
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0)
          echo "VERSION_NAME=${LATEST_TAG}-nvapi-arm64ec-${COMMIT_HASH}" >> $GITHUB_ENV

      - name: Configure Cross-Files
        if: env.SHOULD_BUILD == 'true'
        run: |
          cat <<EOF > arm64ec.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat <<EOF > x86.txt
          [binaries]
          c = 'i686-w64-mingw32-clang'
          cpp = 'i686-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

      - name: Build DXVK
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          
          ninja -C build-ec -j 2
          ninja -C build-x86 -j 2

      - name: Build DXVK-NVAPI
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dxvk-nvapi
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          
          ninja -C build-ec -j 2
          ninja -C build-x86 -j 2

      - name: Package
        if: env.SHOULD_BUILD == 'true'
        run: |
          mkdir -p packaging/system32
          mkdir -p packaging/syswow64
          
          copy_dll() {
            SRC_DIR=$1
            DEST_DIR=$2
            cp "dxvk/$SRC_DIR/src/d3d11/d3d11.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d10/d3d10core.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d9/d3d9.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d8/d3d8.dll" "$DEST_DIR/" || true
            cp "dxvk/$SRC_DIR/src/dxgi/dxgi.dll" "$DEST_DIR/"
          }

          copy_dll "build-ec" "packaging/system32"
          copy_dll "build-x86" "packaging/syswow64"
          
          find dxvk-nvapi/build-ec -name "nvapi64.dll" -exec cp -L {} packaging/system32/ \;
          find dxvk-nvapi/build-x86 -name "nvapi.dll" -exec cp -L {} packaging/syswow64/ \;

          llvm-strip --strip-all packaging/system32/*.dll
          llvm-strip --strip-all packaging/syswow64/*.dll

          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK-NVAPI",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "DXVK ARM64EC + NVAPI",
            "files": [
              {
                "source": "system32/d3d10core.dll",
                "target": "\${system32}/d3d10core.dll"
              },
              {
                "source": "system32/d3d11.dll",
                "target": "\${system32}/d3d11.dll"
              },
              {
                "source": "system32/d3d8.dll",
                "target": "\${system32}/d3d8.dll"
              },
              {
                "source": "system32/d3d9.dll",
                "target": "\${system32}/d3d9.dll"
              },
              {
                "source": "system32/dxgi.dll",
                "target": "\${system32}/dxgi.dll"
              },
              {
                "source": "system32/nvapi64.dll",
                "target": "\${system32}/nvapi64.dll"
              },
              {
                "source": "syswow64/d3d10core.dll",
                "target": "\${syswow64}/d3d10core.dll"
              },
              {
                "source": "syswow64/d3d11.dll",
                "target": "\${syswow64}/d3d11.dll"
              },
              {
                "source": "syswow64/d3d8.dll",
                "target": "\${syswow64}/d3d8.dll"
              },
              {
                "source": "syswow64/d3d9.dll",
                "target": "\${syswow64}/d3d9.dll"
              },
              {
                "source": "syswow64/dxgi.dll",
                "target": "\${syswow64}/dxgi.dll"
              },
              {
                "source": "syswow64/nvapi.dll",
                "target": "\${syswow64}/nvapi.dll"
              }
            ]
          }
          EOF
          
          cd packaging
          tar --zstd -cf ../DXVK-NVAPI-ARM64EC-${{ env.VERSION_NAME }}.wcp *

      - name: Create Release (ARM64EC)
        if: env.SHOULD_BUILD == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dxvk-nvapi-arm64ec-nightly-${{ env.COMMIT_HASH }}
          files: '*.wcp'
          name: "DXVK+NVAPI ARM64EC Nightly ${{ env.COMMIT_HASH }}"
          body: |
            Automated nightly build of DXVK (ARM64EC) bundled with DXVK-NVAPI.
            
            DXVK Commit: https://github.com/doitsujin/dxvk/commit/${{ env.COMMIT_HASH }}
            DXVK-NVAPI Commit: https://github.com/jp7677/dxvk-nvapi/commit/${{ env.NVAPI_HASH }}

      - name: Cleanup Old Releases (ARM64EC)
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName | select(startswith("dxvk-nvapi-arm64ec-nightly-"))' \
          | tail -n +9 \
          | xargs -I {} sh -c 'gh release delete "{}" --cleanup-tag -y'

      - name: Checkout Dashboard
        if: env.SHOULD_BUILD == 'true'
        uses: actions/checkout@v4
        with:
          path: dashboard
          fetch-depth: 0

      - name: Push README Updates (ARM64EC)
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dashboard
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/dxvk-nvapi-arm64ec-nightly-${{ env.COMMIT_HASH }}/DXVK-NVAPI-ARM64EC-${{ env.VERSION_NAME }}.wcp"
          BRANCH_NAME="${{ github.ref_name }}"
          
          git checkout $BRANCH_NAME 2>/dev/null || git checkout -b $BRANCH_NAME
          
          n=0
          until [ "$n" -ge 5 ]
          do
             git pull origin $BRANCH_NAME --rebase
             sed -i "/\*\*DXVK-NVAPI\*\* (ARM64EC)/ s|\[\*\*Download Latest\*\*\]([^)]*)|[**Download Latest**]($DOWNLOAD_URL)|" README.md
             git add README.md
             git commit -m "Update dashboard for DXVK+NVAPI ARM64EC ${{ env.COMMIT_HASH }}" || echo "Nothing to commit"
             if git push origin $BRANCH_NAME; then exit 0; fi
             n=$((n+1))
             sleep 15
          done
          exit 1
