name: Build Dxvk Nightly

on:
  schedule:
    # 9:00 PM CST = 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout DXVK
      uses: actions/checkout@v4
      with:
        repository: doitsujin/dxvk
        path: dxvk
        submodules: recursive
        fetch-depth: 0

    - name: Check for Updates
      id: check
      run: |
        # 1. If Manual Trigger (workflow_dispatch), FORCE BUILD
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "Manual trigger detected. Forcing build..."
          echo "SHOULD_BUILD=true" >> $GITHUB_ENV
        
        # 2. If Schedule, Check for Commits in last 26 hours
        else
          cd dxvk
          if [ -z "$(git log --since='26 hours ago' --pretty=format:'%H')" ]; then
            echo "No new commits in the last 26 hours. Skipping build."
            echo "SHOULD_BUILD=false" >> $GITHUB_ENV
          else
            echo "New commits found! Proceeding with build."
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          fi
        fi

    - name: Install Dependencies
      if: env.SHOULD_BUILD == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build mingw-w64 glslang-tools wine

    - name: Download and Apply Patch
      if: env.SHOULD_BUILD == 'true'
      run: |
        cd dxvk
        wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
        git apply dxvk-gplasync-master.patch

    - name: Build DXVK
      if: env.SHOULD_BUILD == 'true'
      run: |
        cd dxvk
        ./package-release.sh master ../dxvk-built --no-package

    - name: Prepare Package
      if: env.SHOULD_BUILD == 'true'
      run: |
        cd dxvk
        COMMIT_HASH=$(git rev-parse --short HEAD)
        cd ..

        mkdir -p packaging/system32 packaging/syswow64
        cp dxvk-built/dxvk-master/x64/*.dll packaging/system32/
        cp dxvk-built/dxvk-master/x32/*.dll packaging/syswow64/
        
        cat <<EOF > packaging/profile.json
        {
          "type": "DXVK",
          "versionName": "2.7.1-gplasync-${COMMIT_HASH}",
          "versionCode": 0,
          "description": "DXVK Nightly (GPLAsync)\nCommit: ${COMMIT_HASH}",
          "author": "Blank",
          "files": [
            { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
            { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
            { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
            { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
            { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
            { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
            { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
            { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
          ]
        }
        EOF

    - name: Create WCP Package
      if: env.SHOULD_BUILD == 'true'
      run: |
        cd dxvk
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
        cd ..
        tar -cJf dxvk-gplasync-${COMMIT_HASH}.wcp -C packaging .

    - name: Create Release
      if: env.SHOULD_BUILD == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly-${{ env.COMMIT_HASH }}
        files: '*.wcp'
        name: "DXVK Nightly ${{ env.COMMIT_HASH }}"
        body: "Automated nightly build of DXVK (GPLAsync) - Commit ${{ env.COMMIT_HASH }}"

    - name: Delete Older Releases
      if: env.SHOULD_BUILD == 'true'
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 8
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
