name: Build Dxvk Nightly

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout DXVK
      uses: actions/checkout@v4
      with:
        repository: doitsujin/dxvk
        path: dxvk
        submodules: recursive
        fetch-depth: 0

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build mingw-w64 glslang-tools wine

    - name: Download and Apply Patch
      run: |
        cd dxvk
        wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
        git apply dxvk-gplasync-master.patch

    - name: Build DXVK
      run: |
        cd dxvk
        ./package-release.sh master ../dxvk-built --no-package

    - name: Prepare Package
      run: |
        cd dxvk
        COMMIT_HASH=$(git rev-parse --short HEAD)
        cd ..

        mkdir -p packaging/system32 packaging/syswow64
        cp dxvk-built/dxvk-master/x64/*.dll packaging/system32/
        cp dxvk-built/dxvk-master/x32/*.dll packaging/syswow64/
        
        cat <<EOF > packaging/profile.json
        {
          "type": "DXVK",
          "versionName": "2.7.1-gplasync-${COMMIT_HASH}",
          "versionCode": 0,
          "description": "DXVK Nightly (GPLAsync)\nCommit: ${COMMIT_HASH}",
          "author": "Blank",
          "files": [
            { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
            { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
            { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
            { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
            { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
            { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
            { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
            { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
          ]
        }
        EOF

    - name: Create WCP Package
      run: |
        cd dxvk
        COMMIT_HASH=$(git rev-parse --short HEAD)
        cd ..
        tar -cJf dxvk-gplasync-${COMMIT_HASH}.wcp -C packaging .

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dxvk-nightly-build
        path: '*.wcp'
