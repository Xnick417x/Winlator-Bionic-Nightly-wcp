name: Wine 11.0 v80 Stable (Ziad Method)
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ubuntu:20.04

    steps:
      - name: Setup
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y software-properties-common wget unzip git build-essential tar xz-utils flex bison pkg-config gcc-multilib g++-multilib libx11-dev libpulse-dev libsdl2-dev patch python3 autoconf tzdata gettext

      - name: Toolchain
        run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20230919/llvm-mingw-20230919-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar -xf llvm-mingw-20230919-ucrt-ubuntu-20.04-x86_64.tar.xz
          echo "$(pwd)/llvm-mingw-20230919-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH
          wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          echo "NDK_ROOT=$(pwd)/android-ndk-r25c" >> $GITHUB_ENV
          echo "$(pwd)/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Clone
        run: |
          git clone https://github.com/wine-mirror/wine.git source
          cd source
          git checkout wine-11.0

      - name: Patch & Purge
        run: |
          cd source
          # 1. Ziad's Fix: Ensure we don't have conflicting flags
          grep -rl -- "--no-default-config" . | xargs sed -i 's/--no-default-config//g'
          sed -i '/tests\/Makefile/d' configure.ac
          
          # 2. Apply Patches
          for p in c9ee4e003238c9461461156f986d91349de27fea 441c0fe673de0a640e176110d9442e8e41250fd7 6e7166c71de8c09a1c91fb96228920e7085e2366; do
            wget https://github.com/Pipetto-crypto/wine/commit/$p.patch -O p.patch && patch -p1 < p.patch || true
          done
          wget https://github.com/brunodev85/wine-9.2-custom/commit/a4ef2bf8963fe4bfab390eebf73336364ce209bc.patch -O bruno_desktop.patch && patch -p1 < bruno_desktop.patch || true
          wget https://github.com/brunodev85/wine-9.2-custom/commit/73336364ce209bc.patch -O bruno_shell.patch && patch -p1 < bruno_shell.patch || true
          wget https://raw.githubusercontent.com/airidosas252/Wine-Builds/master/address-space-proot.patch && patch -p1 < address-space-proot.patch || true
          wget https://raw.githubusercontent.com/airidosas252/Wine-Builds/master/esync.patch && patch -p1 < esync.patch || true
          
          # Preloader Fix
          sed -i 's/base = (char \*)0x10000;/base = NULL;/g' dlls/ntdll/unix/virtual.c
          sed -i 's/size = 0x110000;/size = 0;/g' dlls/ntdll/unix/virtual.c
          sed -i 's/0x00010000/0x00000000/g' loader/preloader.c || true
          
          autoreconf -f

      - name: Native Tools
