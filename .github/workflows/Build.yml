name: Build DXVK with GPLAsync

on:
  workflow_dispatch:
    inputs:
      dxvk_version:
        description: "DXVK Branch/Tag (e.g., master or v2.1)"
        required: true
        default: "master"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout DXVK
        uses: actions/checkout@v4
        with:
          repository: doitsujin/dxvk
          ref: ${{ inputs.dxvk_version }}
          submodules: recursive

      - name: Download GPLAsync Patch
        run: |
          # Downloading the raw patch file you provided
          wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch -O gplasync.patch

      - name: Apply Patch
        run: |
          # Apply the patch; we use --3way to try and resolve minor conflicts automatically
          git apply --3way --ignore-space-change --ignore-whitespace gplasync.patch
          echo "Patch applied successfully!"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build glslang-tools mingw-w64

      - name: Build DXVK
        run: |
          # DXVK includes a script to handle the cross-compilation setup
          ./package-release.sh master $(pwd)/output --no-package

      - name: Prepare WCP Structure
        run: |
          mkdir -p wcp_package/x64
          mkdir -p wcp_package/x86
          
          # Copy compiled DLLs to the structure Winlator expects
          cp output/dxvk-master/x64/*.dll wcp_package/x64/
          cp output/dxvk-master/x32/*.dll wcp_package/x86/
          
          # Create the file info for Winlator (Optional but good practice)
          echo "DXVK-GPLAsync-Build" > wcp_package/version.txt

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dxvk-gplasync-wcp
          path: wcp_package/
