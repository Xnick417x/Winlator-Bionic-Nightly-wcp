name: Build Box64 & WOWBox64 Nightly

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android-native:
    name: Build Box64 (Android Native)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ptitSeb/box64
          path: source
          submodules: recursive
          fetch-depth: 0

      - name: Check for Updates
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          else
            cd source
            if [ -z "$(git log --since='26 hours ago' --pretty=format:'%H')" ]; then
              echo "SHOULD_BUILD=false" >> $GITHUB_ENV
            else
              echo "SHOULD_BUILD=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Dependencies
        if: env.SHOULD_BUILD == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file

      - name: Setup Android NDK
        if: env.SHOULD_BUILD == 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang" >> $GITHUB_ENV

      - name: Get Version Info
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd source
          MAJOR=$(grep '#define BOX64_MAJOR' src/box64version.h | awk '{print $3}')
          MINOR=$(grep '#define BOX64_MINOR' src/box64version.h | awk '{print $3}')
          REVISION=$(grep '#define BOX64_REVISION' src/box64version.h | awk '{print $3}')
          VERSION="$MAJOR.$MINOR.$REVISION"
          COMMIT=$(git rev-parse --short HEAD)
          echo "FULL_VERSION=${VERSION}-${COMMIT}-nightly" >> $GITHUB_ENV
          echo "COMMIT_HASH=${COMMIT}" >> $GITHUB_ENV

      - name: Apply Local Controller Fix Patch
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd source
          wget -q "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/patch/pipetto-controller-fix.patch" -O my-patch.patch
          patch -p1 < my-patch.patch || true

      - name: Configure and Build
        if: env.SHOULD_BUILD == 'true'
        run: |
          mkdir build
          cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} \
            -DANDROID=1 \
            -DARM_DYNAREC=1 \
            -DBAD_SIGNAL=1 \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64

      - name: Package
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd build
          cat <<EOF > profile.json
          {
            "type": "Box64",
            "versionName": "${{ env.FULL_VERSION }}",
            "versionCode": 0,
            "description": "Box64-${{ env.FULL_VERSION }}",
            "files": [
              {
                "source": "box64",
                "target": "\${bindir}/box64"
              }
            ]
          }
          EOF
          tar -cJf "box64-${{ env.FULL_VERSION }}.wcp" box64 profile.json

      - name: Upload Artifact
        if: env.SHOULD_BUILD == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Box64-Nightly
          path: build/box64-*.wcp
          compression-level: 0

      - name: Create Release (Box64)
        if: env.SHOULD_BUILD == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: box64-nightly-${{ env.COMMIT_HASH }}
          files: build/box64-*.wcp
          name: "Box64 Nightly ${{ env.COMMIT_HASH }}"
          body: |
            Automated nightly build of Box64 (Android Native).
            Commit: https://github.com/ptitSeb/box64/commit/${{ env.COMMIT_HASH }}

      - name: Cleanup Old Releases (Box64)
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName | select(startswith("box64-nightly-"))' \
          | tail -n +9 \
          | xargs -I {} sh -c 'gh release delete "{}" --cleanup-tag -y'

      - name: Update Dashboard (Box64)
        if: env.SHOULD_BUILD == 'true'
        uses: actions/checkout@v4
        with:
          path: dashboard
          fetch-depth: 0

      - name: Push README Updates (Box64)
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dashboard
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/box64-nightly-${{ env.COMMIT_HASH }}/box64-${{ env.FULL_VERSION }}.wcp"
          BRANCH_NAME="${{ github.ref_name }}"
          git checkout $BRANCH_NAME 2>/dev/null || git checkout -b $BRANCH_NAME
          n=0
          until [ "$n" -ge 5 ]
          do
             git pull origin $BRANCH_NAME --rebase
             sed -i "/\*\*Box64\*\* (Standard)/ s|\[\*\*Download Latest\*\*\]([^)]*)|[**Download Latest**]($DOWNLOAD_URL)|" README.md
             git add README.md
             git commit -m "Update dashboard for Box64 ${{ env.COMMIT_HASH }} [skip ci]" || echo "Nothing to commit"
             if git push origin $BRANCH_NAME; then exit 0; fi
             n=$((n+1))
             sleep 15
          done
          exit 1

  build-wowbox64:
    name: Build WOWBox64 (MinGW)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ptitSeb/box64
          path: source
          submodules: recursive
          fetch-depth: 0

      - name: Check for Updates
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          else
            cd source
            if [ -z "$(git log --since='26 hours ago' --pretty=format:'%H')" ]; then
              echo "SHOULD_BUILD=false" >> $GITHUB_ENV
            else
              echo "SHOULD_BUILD=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Dependencies
        if: env.SHOULD_BUILD == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 wget tar

      - name: Setup Toolchain
        if: env.SHOULD_BUILD == 'true'
        run: |
          LLVM_MINGW_VERSION=20240619
          wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar -xf llvm-mingw-*.tar.xz
          echo "MINGW_PATH=$PWD/$(ls -d llvm-mingw-* | head -n 1)/bin" >> $GITHUB_ENV

      - name: Clone and Patch
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd source
          echo -e '\nint __mingw_vsprintf(char* buffer, const char* format, va_list args) { return vsprintf(buffer, format, args); }' >> wine/common/crt.c

      - name: Get Version Info
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd source
          MAJOR=$(grep '#define BOX64_MAJOR' src/box64version.h | awk '{print $3}')
          MINOR=$(grep '#define BOX64_MINOR' src/box64version.h | awk '{print $3}')
          REVISION=$(grep '#define BOX64_REVISION' src/box64version.h | awk '{print $3}')
          VERSION="$MAJOR.$MINOR.$REVISION"
          COMMIT=$(git rev-parse --short HEAD)
          echo "FULL_VERSION=${VERSION}-${COMMIT}-nightly" >> $GITHUB_ENV
          echo "COMMIT_HASH=${COMMIT}" >> $GITHUB_ENV

      - name: Apply Local Controller Fix Patch
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd source
          wget -q "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/patch/pipetto-controller-fix.patch" -O my-patch.patch
          patch -p1 < my-patch.patch || true

      - name: Configure and Build
        if: env.SHOULD_BUILD == 'true'
        run: |
          export PATH=$PATH:${{ env.MINGW_PATH }}
          mkdir build
          cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=aarch64-w64-mingw32-gcc \
            -DWOW64=1 \
            -DARM_DYNAREC=1 \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc) wowbox64

      - name: Package
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd build/wowbox64-prefix/src/wowbox64-build
          cat <<EOF > profile.json
          {
            "type": "WOWBox64",
            "versionName": "${{ env.FULL_VERSION }}",
            "versionCode": 0,
            "description": "WOWBox64-${{ env.FULL_VERSION }}",
            "files": [
              {
                "source": "wowbox64.dll",
                "target": "\${system32}/wowbox64.dll"
              }
            ]
          }
          EOF
          tar -cJf "WOWBox64-${{ env.FULL_VERSION }}.wcp" wowbox64.dll profile.json

      - name: Upload Artifact
        if: env.SHOULD_BUILD == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: WOWBox64-Nightly
          path: build/wowbox64-prefix/src/wowbox64-build/WOWBox64-*.wcp
          compression-level: 0

      - name: Create Release (WOWBox64)
        if: env.SHOULD_BUILD == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: wowbox64-nightly-${{ env.COMMIT_HASH }}
          files: build/wowbox64-prefix/src/wowbox64-build/WOWBox64-*.wcp
          name: "WOWBox64 Nightly ${{ env.COMMIT_HASH }}"
          body: |
            Automated nightly build of WOWBox64 (MinGW).
            Commit: https://github.com/ptitSeb/box64/commit/${{ env.COMMIT_HASH }}

      - name: Cleanup Old Releases (WOWBox64)
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName | select(startswith("wowbox64-nightly-"))' \
          | tail -n +9 \
          | xargs -I {} sh -c 'gh release delete "{}" --cleanup-tag -y'

      - name: Update Dashboard (WOWBox64)
        if: env.SHOULD_BUILD == 'true'
        uses: actions/checkout@v4
        with:
          path: dashboard
          fetch-depth: 0

      - name: Push README Updates (WOWBox64)
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd dashboard
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/wowbox64-nightly-${{ env.COMMIT_HASH }}/WOWBox64-${{ env.FULL_VERSION }}.wcp"
          BRANCH_NAME="${{ github.ref_name }}"
          git checkout $BRANCH_NAME 2>/dev/null || git checkout -b $BRANCH_NAME
          n=0
          until [ "$n" -ge 5 ]
          do
             git pull origin $BRANCH_NAME --rebase
             sed -i "/\*\*WOWBox64\*\*/ s|\[\*\*Download Latest\*\*\]([^)]*)|[**Download Latest**]($DOWNLOAD_URL)|" README.md
             git add README.md
             git commit -m "Update dashboard for WOWBox64 ${{ env.COMMIT_HASH }} [skip ci]" || echo "Nothing to commit"
             if git push origin $BRANCH_NAME; then exit 0; fi
             n=$((n+1))
             sleep 15
          done
          exit 1
